// Time to Play - Database Schema
// Based on reference/03-database-schema.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(cuid())
  username      String?   @unique
  email         String?   @unique
  passwordHash  String?

  // User type
  isGuest       Boolean   @default(true)
  guestToken    String?   @unique

  // Profile
  displayName   String
  avatarUrl     String?
  themeId       String    @default("ocean-breeze")

  // Timestamps
  createdAt     DateTime  @default(now())
  lastSeenAt    DateTime  @default(now())

  // Relations
  games         GamePlayer[]
  stats         UserStats?
  chatMessages  ChatMessage[]
  winnerGames   Game[]     @relation("GameWinner")

  @@index([email])
  @@index([guestToken])
}

model UserStats {
  id              String   @id @default(cuid())

  // Relations
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // War game stats
  warGamesPlayed  Int      @default(0)
  warGamesWon     Int      @default(0)
  warGamesLost    Int      @default(0)
  warWinRate      Float    @default(0)
  warElo          Int      @default(1200)

  // Chess stats (future)
  chessGamesPlayed Int     @default(0)
  chessGamesWon    Int     @default(0)
  chessGamesLost   Int     @default(0)
  chessElo         Int     @default(1200)

  // Overall
  totalGamesPlayed Int     @default(0)
  totalGamesWon    Int     @default(0)
  longestWinStreak Int     @default(0)
  currentWinStreak Int     @default(0)

  // Timestamps
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// GAME MANAGEMENT
// ============================================================================

enum GameType {
  WAR
  CHESS
  HEARTS
  SPADES
}

enum GameStatus {
  WAITING     // Waiting for players
  READY       // All players joined, not started
  IN_PROGRESS // Game is active
  COMPLETED   // Game finished normally
  ABANDONED   // Game abandoned/timed out
}

model Game {
  id              String      @id @default(cuid())
  gameType        GameType
  status          GameStatus  @default(WAITING)

  // Game configuration
  maxPlayers      Int         @default(2)
  currentTurn     Int         @default(0)

  // Timer configuration (JSON)
  timerConfig     Json?

  // Timer state (JSON)
  timerState      Json?

  // Game state snapshot (JSON)
  stateSnapshot   Json?

  // Results
  winnerId        String?
  winner          User?       @relation("GameWinner", fields: [winnerId], references: [id])

  // Timestamps
  createdAt       DateTime    @default(now())
  startedAt       DateTime?
  completedAt     DateTime?

  // Relations
  players         GamePlayer[]
  moves           GameMove[]
  chatMessages    ChatMessage[]

  @@index([status])
  @@index([gameType])
  @@index([createdAt])
}

model GamePlayer {
  id              String      @id @default(cuid())

  // Relations
  gameId          String
  game            Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Player info
  playerIndex     Int
  isReady         Boolean     @default(false)

  // Connection status
  isConnected     Boolean     @default(false)
  lastConnectedAt DateTime    @default(now())

  // Results
  placement       Int?
  score           Int?

  // Timestamps
  joinedAt        DateTime    @default(now())

  @@unique([gameId, userId])
  @@unique([gameId, playerIndex])
  @@index([userId])
  @@index([gameId])
}

model GameMove {
  id              String      @id @default(cuid())

  // Relations
  gameId          String
  game            Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  userId          String

  // Move data
  moveNumber      Int
  moveData        Json

  // Timestamps
  createdAt       DateTime    @default(now())

  @@index([gameId, moveNumber])
  @@index([gameId, createdAt])
}

// ============================================================================
// CHAT SYSTEM
// ============================================================================

enum MessageType {
  TEXT
  EMOJI
  SYSTEM
}

model ChatMessage {
  id          String      @id @default(cuid())
  gameId      String
  game        Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)

  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  message     String
  type        MessageType @default(TEXT)

  // For moderation
  isFiltered  Boolean     @default(false)

  createdAt   DateTime    @default(now())

  @@index([gameId, createdAt])
  @@index([userId])
}
